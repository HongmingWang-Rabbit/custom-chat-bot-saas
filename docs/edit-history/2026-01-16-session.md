# Edit History - January 16, 2026

## Session Summary

**Session 1:** Fixed critical provisioning bug where pooler URL host was hardcoded incorrectly. The host varies per project (`aws-0` vs `aws-1`), causing "Tenant or user not found" errors. Now fetches actual pooler config from Supabase Management API. Also implemented async provisioning pattern with background migrations.

**Session 2:** Implemented tenant hard delete functionality that permanently removes tenant AND Supabase project (database + storage). Also fixed failing tests from Session 1 changes.

**Session 3:** Fixed Q&A logging to record all interactions (greetings, no-context queries). Fixed Q&A logs API 400 error caused by null vs undefined in Zod validation. Replaced all `console.log` calls with Pino structured logging in `provisioning.ts` and `storage-setup.ts`.

---

## Changes

### 1. Provisioning Pooler URL Fix (CRITICAL BUG FIX)

**Commit:** `21037ce`

**Files Modified:**
- `src/lib/supabase/provisioning.ts`

**Problem:**
The pooler database URL was constructed with a hardcoded host pattern `aws-0-{region}.pooler.supabase.com`, but Supabase assigns different hosts per project (e.g., `aws-1-{region}`). This caused "Tenant or user not found" errors when connecting to newly provisioned databases.

**Solution:**
- Added `getPoolerConfig()` function to fetch actual pooler configuration from Supabase Management API (`/projects/{ref}/config/database/pooler`)
- Changed `buildPoolerDatabaseUrl()` to use the API-provided config instead of constructing the URL manually
- Added `buildDirectDatabaseUrl()` for direct connections (used during initial setup when pooler may not be ready)

**Code Changes:**
```typescript
// NEW: Fetch actual pooler config from API
async function getPoolerConfig(projectRef: string): Promise<PoolerConfig> {
  const configs = await supabaseApi<PoolerConfig[]>(
    `/projects/${projectRef}/config/database/pooler`
  );
  const primaryConfig = configs.find(
    (c) => c.database_type === 'PRIMARY'
  );
  return primaryConfig;
}

// UPDATED: Use API config instead of hardcoded URL
function buildPoolerDatabaseUrl(poolerConfig: PoolerConfig, dbPassword: string): string {
  return `postgresql://${poolerConfig.db_user}:${encodeURIComponent(
    dbPassword
  )}@${poolerConfig.db_host}:${poolerConfig.db_port}/${poolerConfig.db_name}?sslmode=require`;
}
```

---

### 2. Async Provisioning Implementation

**Files Modified:**
- `src/db/schema/main.ts` - Added 'provisioning' and 'error' to TenantStatus type
- `src/lib/services/tenant-service.ts` - Added `getTenantAnyStatus()`, `updateTenantStatus()`, status param to `createTenant()`
- `src/app/api/tenants/[slug]/route.ts` - Updated GET to return provisioning status info
- `src/app/api/tenants/provision/route.ts` - Created async provisioning endpoint

**Features:**
- Provisioning returns HTTP 202 immediately (~11 seconds) instead of waiting for migrations
- Background migration runner with 5-minute timeout (60 retries × 5 seconds)
- New tenant statuses: `provisioning` (in progress), `error` (failed), `active` (ready)
- Status polling endpoint: `GET /api/tenants/{slug}` returns `ready: true/false`

**Flow:**
```
POST /api/tenants/provision
    │
    ├─► Create Supabase project (sync, ~10s)
    ├─► Create storage bucket (sync, ~1s)
    ├─► Insert tenant with status="provisioning" (sync)
    ├─► Return HTTP 202 immediately
    │
    └─► Background: Wait for DB ready → Run migrations → Update status to "active"
```

---

### 3. Test Results

**Provisioning Test:**
- Created tenant `test-fix-001` in 11 seconds
- Background migrations completed in ~8 seconds
- Status changed from `provisioning` to `active`
- Document upload, Q&A, and file download all working

**Verified:**
- Database host correctly shows `aws-1-us-east-1` (from API) instead of hardcoded `aws-0-us-east-1`
- Storage bucket created with CDN
- Signed URLs work for file downloads

---

## Files Changed Summary

| File | Action | Description |
|------|--------|-------------|
| `src/lib/supabase/provisioning.ts` | Modified | Fetch pooler config from API, add direct URL builder |
| `src/db/schema/main.ts` | Modified | Add 'provisioning' and 'error' statuses |
| `src/lib/services/tenant-service.ts` | Modified | Add status methods and params |
| `src/app/api/tenants/[slug]/route.ts` | Modified | Return provisioning status info |
| `src/app/api/tenants/provision/route.ts` | Created | Async provisioning endpoint |

---

## Commits

| Hash | Message |
|------|---------|
| `21037ce` | fix(provisioning): fetch pooler config from API instead of hardcoding host |

---

## Session 2 Changes

### 4. Tenant Hard Delete Feature

**Files Modified:**
- `src/lib/services/tenant-service.ts` - Added `hardDeleteTenant()` method
- `src/app/api/tenants/[slug]/route.ts` - Updated DELETE handler to support `?hard=true`
- `src/lib/services/__tests__/tenant-service.test.ts` - Added 7 tests for hard delete

**Feature:**
Tenant deletion now supports two modes:
- **Soft delete** (default): Sets `status: 'deleted'`, keeps data
- **Hard delete** (`?hard=true`): Permanently removes tenant AND Supabase project

**API:**
```bash
# Soft delete - marks as deleted, keeps data
DELETE /api/tenants/{slug}

# Hard delete - permanently removes everything
DELETE /api/tenants/{slug}?hard=true
```

**Response (hard delete):**
```json
{
  "success": true,
  "message": "Tenant permanently deleted",
  "deleted": {
    "tenant": true,
    "supabaseProject": true,
    "projectRef": "abc123xyz"
  }
}
```

**Implementation Details:**
- Extracts project ref from encrypted database URL
- Calls Supabase Management API to delete project (includes storage)
- Handles edge cases: project not found, provisioning not configured
- Clears connection pool before deletion

---

### 5. Test Fixes

**Files Modified:**
- `src/lib/supabase/__tests__/provisioning.test.ts` - Added mock for `getPoolerConfig()` API call
- `src/lib/rag/__tests__/service.test.ts` - Updated no-context response text expectations

**Issues Fixed:**
- Provisioning tests failing due to missing `mockPoolerConfigResponse`
- RAG service tests failing due to changed no-context response message

**Test Results:**
- All 478 tests passing (up from 464)

---

## Files Changed Summary (Session 2)

| File | Action | Description |
|------|--------|-------------|
| `src/lib/services/tenant-service.ts` | Modified | Added `hardDeleteTenant()` method |
| `src/app/api/tenants/[slug]/route.ts` | Modified | Support `?hard=true` for permanent deletion |
| `src/lib/services/__tests__/tenant-service.test.ts` | Modified | Added 7 hard delete tests |
| `src/lib/supabase/__tests__/provisioning.test.ts` | Modified | Fixed tests with pooler config mock |
| `src/lib/rag/__tests__/service.test.ts` | Modified | Fixed no-context response expectations |

---

## Session 3 Changes

### 6. Q&A Logging Fix (BUG FIX)

**Files Modified:**
- `src/lib/rag/service.ts`

**Problem:**
Q&A interactions were not being logged to the database. The `logInteraction` method was only called when relevant chunks were found, missing:
- Conversational queries (greetings, help requests)
- Queries with no matching context

**Solution:**
Added `logInteraction` calls for all interaction types in both `query()` and `queryStream()` methods:

```typescript
// In query() - for conversational queries:
if (this.isConversationalQuery(request.query)) {
  const response = this.createNoContextResponse(request.query, 0);
  await this.logInteraction({
    query: request.query,
    answer: response.answer,
    confidence: 0,
    retrievedChunks: [],
    citations: [],
    sessionId: request.sessionId,
    duration: Date.now() - startTime,
  });
  return response;
}

// For no-context queries:
if (retrieval.chunks.length === 0) {
  const response = this.createNoContextResponse(request.query, retrieval.queryEmbeddingTokens);
  await this.logInteraction({...});
  return response;
}
```

Also changed debug-level logs to INFO level for better visibility.

---

### 7. Q&A Logs API Fix (BUG FIX)

**Files Modified:**
- `src/app/api/qa-logs/route.ts`

**Problem:**
`GET /api/qa-logs?tenantSlug=omeca` returned 400 Bad Request. The `searchParams.get()` method returns `null` for missing params, but Zod's `.optional()` expects `undefined`.

**Solution:**
Convert null to undefined for optional parameters:

```typescript
const rawParams = {
  tenantSlug: searchParams.get('tenantSlug'),
  flagged: searchParams.get('flagged') ?? undefined,  // null → undefined
  reviewed: searchParams.get('reviewed') ?? undefined,
  limit: searchParams.get('limit') ?? undefined,
  offset: searchParams.get('offset') ?? undefined,
};
```

---

### 8. Console.log to Pino Logger (CODE QUALITY)

**Files Modified:**
- `src/lib/supabase/provisioning.ts` - Replaced 22 console.log/console.error calls
- `src/lib/supabase/storage-setup.ts` - Replaced 10 console.log calls

**Changes:**
Added Pino structured logging with child loggers:

```typescript
import { logger } from '@/lib/logger';
const log = logger.child({ layer: 'provisioning', service: 'SupabaseProvisioning' });

// Example replacements:
// Before: console.log(`[Provisioning] Creating project...`);
// After:  log.info({ event: 'create_project_start', tenantSlug, region }, 'Creating Supabase project');

// Before: console.error(`[Provisioning] Failed:`, error);
// After:  log.error({ event: 'provisioning_failed', tenantSlug, error }, 'Failed to provision');
```

**Benefits:**
- Structured JSON logs for better parsing
- Consistent log levels (info, debug, warn, error)
- Event-based logging with contextual metadata
- Works with LOG_LEVEL environment variable

---

### 9. Test Fixes (Session 3)

**Files Modified:**
- `src/lib/services/__tests__/tenant-service.test.ts` - Added `generateSecurePassword` mock, fixed tenant existence checks
- `src/lib/supabase/__tests__/provisioning.test.ts` - Updated `provisionSupabaseProject` call signature

**Issues Fixed:**
- Missing `generateSecurePassword` mock in tenant service tests
- `provisionSupabaseProject` signature changed from string to options object
- Tenant existence checks needed proper mock setup

**Test Results:**
- All 32 provisioning tests passing
- All 32 storage setup tests passing

---

## Files Changed Summary (Session 3)

| File | Action | Description |
|------|--------|-------------|
| `src/lib/rag/service.ts` | Modified | Log all Q&A interactions (greetings, no-context) |
| `src/app/api/qa-logs/route.ts` | Modified | Fix null→undefined for Zod validation |
| `src/lib/supabase/provisioning.ts` | Modified | Replace console.log with Pino logger |
| `src/lib/supabase/storage-setup.ts` | Modified | Replace console.log with Pino logger |
| `src/lib/services/__tests__/tenant-service.test.ts` | Modified | Add missing mocks, fix test assertions |
| `src/lib/supabase/__tests__/provisioning.test.ts` | Modified | Update function signature in tests |

---

## Session 4 Changes

### 10. Q&A Logs AI Analysis Feature (NEW)

**Files Created:**
- `src/app/api/qa-logs/analyze/route.ts` - Analysis API endpoint
- `src/lib/llm/analysis-prompts.ts` - LLM prompts for analysis

**Feature:**
Added AI-powered Q&A log analysis that uses LLM to identify patterns, user concerns, and logs needing attention.

**API:**
```bash
POST /api/qa-logs/analyze
Content-Type: application/json

{
  "tenantSlug": "omeca",
  "logs": [
    {
      "id": "log-id",
      "question": "What is...",
      "answer": "The answer is...",
      "confidence": 0.85,
      "flagged": false
    }
  ]
}
```

**Response:**
```json
{
  "summary": {
    "topTopics": ["topic1", "topic2"],
    "userConcerns": ["concern1", "concern2"],
    "attentionNeeded": [
      { "logId": "...", "reason": "...", "priority": "high" }
    ],
    "overallInsights": "Summary..."
  },
  "stats": {
    "totalAnalyzed": 25,
    "avgConfidence": 0.72,
    "lowConfidenceCount": 5,
    "flaggedCount": 2
  },
  "tokensUsed": 1234
}
```

**UI Integration:**
- Added "AI Analyze" button to Q&A Review page (`/admin/review`)
- New `AnalysisModal` component displays results with:
  - Stats grid (total, avg confidence, low confidence, flagged)
  - Top topics as tags
  - User concerns list
  - Clickable attention-needed items that link to specific logs
  - Overall insights summary

---

### 11. Document Management Components Refactor (CODE QUALITY)

**Files Created:**
- `src/components/documents/types.ts` - Shared types (Document, Tenant)
- `src/components/documents/constants.ts` - Shared constants (DOC_TYPES, STATUS_COLORS, formatFileSize)
- `src/components/documents/ConfirmModal.tsx` - Reusable confirmation dialog
- `src/components/documents/DocumentViewModal.tsx` - Document details viewer
- `src/components/documents/DocumentEditModal.tsx` - Document metadata editor
- `src/components/documents/UploadModal.tsx` - File upload modal with drag & drop
- `src/components/documents/DocumentCard.tsx` - Document card with actions
- `src/components/documents/index.ts` - Barrel exports

**Files Modified:**
- `src/app/admin/documents/page.tsx` - Reduced from 980 to 243 lines

**Changes:**
Split the large documents page into focused, reusable components:

| Component | Lines | Purpose |
|-----------|-------|---------|
| types.ts | 15 | Document/Tenant interfaces |
| constants.ts | 33 | DOC_TYPES, STATUS_COLORS, formatFileSize |
| ConfirmModal.tsx | 72 | Reusable confirm dialog (danger/primary variants) |
| DocumentViewModal.tsx | 107 | View document details |
| DocumentEditModal.tsx | 134 | Edit document metadata |
| UploadModal.tsx | 264 | File upload with drag & drop |
| DocumentCard.tsx | 152 | Document card with actions |
| index.ts | 23 | Barrel exports |

**Benefits:**
- Improved code organization and maintainability
- Reusable components across the app
- Eliminated duplicate code (DOC_TYPES, formatFileSize)
- Easier testing of individual components

---

### 12. Minor Fixes

**Files Modified:**
- `src/app/api/qa-logs/route.ts` - Fixed null → undefined conversion for Zod validation
- `src/lib/services/tenant-service.ts` - Added `getTenantBySlugNoStatus()` method

---

## Files Changed Summary (Session 4)

| File | Action | Description |
|------|--------|-------------|
| `src/app/api/qa-logs/analyze/route.ts` | Created | AI analysis endpoint for Q&A logs |
| `src/lib/llm/analysis-prompts.ts` | Created | LLM prompts for log analysis |
| `src/app/admin/review/page.tsx` | Modified | Added AI Analyze button and AnalysisModal |
| `src/components/documents/types.ts` | Created | Shared Document/Tenant types |
| `src/components/documents/constants.ts` | Created | Shared constants and utilities |
| `src/components/documents/ConfirmModal.tsx` | Created | Reusable confirmation modal |
| `src/components/documents/DocumentViewModal.tsx` | Created | Document view modal |
| `src/components/documents/DocumentEditModal.tsx` | Created | Document edit modal |
| `src/components/documents/UploadModal.tsx` | Created | File upload modal |
| `src/components/documents/DocumentCard.tsx` | Created | Document card component |
| `src/components/documents/index.ts` | Created | Barrel exports |
| `src/app/admin/documents/page.tsx` | Modified | Refactored to use extracted components |
| `src/app/api/qa-logs/route.ts` | Modified | Fixed null→undefined for Zod |
| `src/lib/services/tenant-service.ts` | Modified | Added getTenantBySlugNoStatus() |

---

## Session 5 Changes

### 13. Redis Cache Code Review Fixes (CODE QUALITY)

**Files Modified:**
- `src/lib/cache/cache-key.ts` - Extract HASH_LENGTH constant
- `src/lib/cache/redis-client.ts` - Extract timeout and reconnect constants
- `src/lib/cache/rag-cache.ts` - Extract SCAN_BATCH_SIZE constant
- `src/lib/cache/index.ts` - Export new constants
- `src/lib/cache/__tests__/cache-key.test.ts` - Use HASH_LENGTH constant
- `src/db/schema/tenant.ts` - Add cacheHit field to DebugInfo
- `src/lib/rag/service.ts` - Add cache hit logging and streaming cache support

**Files Created:**
- `src/lib/cache/__tests__/redis-client.test.ts` - 24 tests for redis-client module

**Changes:**

Following code review recommendations, implemented 4 improvements:

#### 13.1 Extract Magic Numbers to Named Constants

| File | Constants Added |
|------|-----------------|
| `cache-key.ts` | `HASH_LENGTH = 32` |
| `redis-client.ts` | `DEFAULT_CONNECT_TIMEOUT_MS = 5000`, `DEFAULT_COMMAND_TIMEOUT_MS = 3000`, `MAX_RECONNECT_DELAY_MS = 30000`, `RECONNECT_BACKOFF_BASE_MS = 100` |
| `rag-cache.ts` | `SCAN_BATCH_SIZE = 100` |

```typescript
// cache-key.ts
export const HASH_LENGTH = 32;
const hash = crypto.createHash('sha256').update(normalized).digest('hex').slice(0, HASH_LENGTH);

// redis-client.ts
export const DEFAULT_CONNECT_TIMEOUT_MS = 5000;
export const DEFAULT_COMMAND_TIMEOUT_MS = 3000;
export const MAX_RECONNECT_DELAY_MS = 30000;
export const RECONNECT_BACKOFF_BASE_MS = 100;
```

#### 13.2 Add Tests for redis-client.ts

Created comprehensive test suite with 24 tests covering:
- Constants (timeout values, reconnect parameters)
- `isRedisConfigured()` function
- `getRedisClient()` connection and error handling
- `closeRedisConnection()` cleanup
- `isRedisAvailable()` health check
- URL masking for secure logging
- Reconnect strategy exponential backoff

```typescript
// redis-client.test.ts excerpt
describe('redis-client constants', () => {
  it('DEFAULT_CONNECT_TIMEOUT_MS is 5 seconds', () => {
    expect(DEFAULT_CONNECT_TIMEOUT_MS).toBe(5000);
  });
});

describe('reconnect strategy', () => {
  it('calculates exponential backoff correctly', () => {
    const calculateDelay = (retries: number) =>
      Math.min(retries * RECONNECT_BACKOFF_BASE_MS, MAX_RECONNECT_DELAY_MS);
    expect(calculateDelay(300)).toBe(30000); // Hits max
  });
});
```

#### 13.3 Add Cache Hit Logging to qa_logs

Added `cacheHit` field to `DebugInfo` interface in tenant schema:

```typescript
// src/db/schema/tenant.ts
export interface DebugInfo {
  retrievalMs?: number;
  llmMs?: number;
  totalMs?: number;
  model?: string;
  chunksRetrieved?: number;
  promptTokens?: number;
  completionTokens?: number;
  /** Whether response was served from cache */
  cacheHit?: boolean;
}
```

Updated `logInteraction()` in RAGService to log cache hits:

```typescript
// When cache hit occurs
await this.logInteraction({
  query: request.query,
  answer: cached.answer,
  confidence: cached.confidence,
  retrievedChunks: [],
  citations: [],
  sessionId: request.sessionId,
  duration: Date.now() - startTime,
  cacheHit: true,  // <-- New field
});
```

#### 13.4 Add Cache Support to Streaming Endpoint

Added full cache support to `queryStream()` method:

```typescript
async queryStream(request: RAGRequest, callbacks: RAGStreamCallbacks): Promise<void> {
  // 1. Check cache first
  const cached = await this.cacheService.get(request.tenantSlug, request.query);
  if (cached) {
    log.info({ tenant: request.tenantSlug, event: 'cache_hit_stream' }, 'Returning cached RAG response (streaming)');
    callbacks.onChunk?.(cached.answer);
    callbacks.onCitations?.(cached.citations);
    await this.logInteraction({...cacheHit: true...});
    callbacks.onComplete?.(cached);
    return;
  }

  // 2. If no cache, retrieve and generate...
  // 3. After streaming completes, cache the response
  await this.cacheService.set(request.tenantSlug, request.query, response);
}
```

---

## Files Changed Summary (Session 5)

| File | Action | Description |
|------|--------|-------------|
| `src/lib/cache/cache-key.ts` | Modified | Added HASH_LENGTH constant |
| `src/lib/cache/redis-client.ts` | Modified | Added timeout and reconnect constants |
| `src/lib/cache/rag-cache.ts` | Modified | Added SCAN_BATCH_SIZE constant |
| `src/lib/cache/index.ts` | Modified | Export new constants |
| `src/lib/cache/__tests__/cache-key.test.ts` | Modified | Use HASH_LENGTH constant |
| `src/lib/cache/__tests__/redis-client.test.ts` | Created | 24 tests for redis-client module |
| `src/db/schema/tenant.ts` | Modified | Added cacheHit to DebugInfo interface |
| `src/lib/rag/service.ts` | Modified | Cache hit logging + streaming cache support |

---

## Test Results

All 610 tests passing after Session 5 changes.
