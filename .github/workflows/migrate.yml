name: Database Migrations

on:
  push:
    branches: [main]
    paths:
      # Only run when schema or migration files change
      - 'src/db/schema/**'
      - 'src/lib/supabase/tenant-migrations.ts'
      - 'scripts/migrate-all.ts'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no changes)'
        required: false
        default: false
        type: boolean
      target:
        description: 'Migration target'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - main-only
          - tenants-only

env:
  NODE_VERSION: '20'

jobs:
  check-changes:
    name: Check for Schema Changes
    runs-on: ubuntu-latest
    outputs:
      should_migrate: ${{ steps.check.outputs.should_migrate }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for schema changes
        id: check
        run: |
          # For workflow_dispatch, always run
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should_migrate=true" >> $GITHUB_OUTPUT
            echo "Manual trigger - will run migrations"
            exit 0
          fi

          # Check if schema files changed
          CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -E '(schema/|migrations|migrate)' || true)
          if [ -n "$CHANGED" ]; then
            echo "should_migrate=true" >> $GITHUB_OUTPUT
            echo "Schema changes detected:"
            echo "$CHANGED"
          else
            echo "should_migrate=false" >> $GITHUB_OUTPUT
            echo "No schema changes detected"
          fi

  migrate:
    name: Run Migrations
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.should_migrate == 'true'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Determine migration flags
        id: flags
        run: |
          FLAGS=""

          # Handle dry run
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            FLAGS="$FLAGS --dry-run"
          fi

          # Handle target
          case "${{ github.event.inputs.target }}" in
            "main-only")
              FLAGS="$FLAGS --main-only"
              ;;
            "tenants-only")
              FLAGS="$FLAGS --tenants-only"
              ;;
          esac

          echo "flags=$FLAGS" >> $GITHUB_OUTPUT

      - name: Run database migrations
        run: npm run migrate:all -- ${{ steps.flags.outputs.flags }}
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          MASTER_KEY: ${{ secrets.MASTER_KEY }}

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Database migrations failed. Please check the logs and run migrations manually if needed."

  notify:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [check-changes, migrate]
    if: always() && needs.check-changes.outputs.should_migrate == 'true'
    steps:
      - name: Migration Summary
        run: |
          if [ "${{ needs.migrate.result }}" = "success" ]; then
            echo "✅ Database migrations completed successfully"
          elif [ "${{ needs.migrate.result }}" = "failure" ]; then
            echo "❌ Database migrations failed"
            exit 1
          elif [ "${{ needs.migrate.result }}" = "skipped" ]; then
            echo "⏭️ Database migrations skipped"
          fi
